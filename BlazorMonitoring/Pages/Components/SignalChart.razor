@using FM4017Library.Dtos
@using FM4017Library.Helpers

<SfChart>
    <ChartPrimaryXAxis Format="hh:mm" ValueType="Syncfusion.Blazor.Charts.ValueType.DateTime" /> @*Title="TimeStamp"*@
    @*<ChartPrimaryYAxis Title="Value" />*@
    <ChartZoomSettings EnableMouseWheelZooming="true" EnablePinchZooming="true" EnableSelectionZooming="true"></ChartZoomSettings>
    <ChartTooltipSettings Enable="true" />
    <ChartLegendSettings Visible="true" Position="LegendPosition.Top" />
    <ChartSeriesCollection>
        @foreach (var signalsList in UniqueSignalsLists)
        {
            <ChartSeries DataSource="@signalsList" 
                Name="@(Prettify.Unit(signalsList?.FirstOrDefault()?.Unit))" 
                XName="TimeStamp" 
                YName="Value" 
                Type="ChartSeriesType.Line">
            </ChartSeries>
        }
    </ChartSeriesCollection>
</SfChart>

@code {
    [Parameter]
    public List<SignalNode>? SignalNodes { get; set; }

    //public List<Signal>? Signals 
    //{
    //    get 
    //    {
    //        List<Signal> result = new List<Signal>();

    //        if (SignalNodes is not null)
    //        {
    //            foreach (var signal in SignalNodes)
    //            {
    //                if (signal?.Timestamp is not null)
    //                {
    //                    result.Add(new Signal { 
    //                        TimeStamp = signal.Timestamp!.Value, 
    //                        Value = Convert.ToDouble(signal?.Data?.RawValue) });
    //                }
    //            }
    //        }
    //        return result; 
    //    }
    //}

    // Split to list per unit

    public List<List<Signal>> UniqueSignalsLists
    {
        get
        {
            List<List<Signal>> result = new ();

            // find # unique units
            List<SignalNode>? uniqueUnitSignals = SignalNodes?.DistinctBy(t => t.Unit).ToList();

            if (uniqueUnitSignals is not null)
            {
                foreach (var uniqeUnit in uniqueUnitSignals)
                {
                    // holds result per unit
                    List<Signal> unitResult = new();

                    foreach (var signal in SignalNodes!.Where(t => t.Unit == uniqeUnit.Unit))
                    {
                        if (signal?.Timestamp is not null)
                        {
                            unitResult.Add(new Signal
                                {
                                    TimeStamp = signal.Timestamp!.Value,
                                    Value = Convert.ToDouble(signal?.Data?.RawValue),
                                    Unit = signal?.Unit
                        });
                        }
                    }
                    result.Add(unitResult);
                }
            }
            return result;
        }
    }


    public class Signal
    {
        public DateTime TimeStamp { get; set; }
        public double Value { get; set; }
        public string? Unit { get; set; }
    }
}
