@using FM4017Library.Dtos

<div class="controlRow">
    <button class="btn btn-primary" @onclick=Home>Home</button>
    <br />
    <br />
</div>


<h5>Subspaces in selected Space</h5>
Selected Space: @_selectedSpace?.Name (id: @_selectedSpace?.Id)


<table class="table table-striped table-light table-hover">
    <thead>
        <tr>
            <th>Name</th>
            <th>Id</th>
            <th>Created At</th>
            <th>Updated At</th>
            <th>Latitude</th>
            <th>Longitude</th>
            <th>Sub Spaces</th>
            <th>Points</th>
            <th>ImageUrl</th>
        </tr>
    </thead>
    <tbody>
        @if (_selectedSpaces != null)
        {
            @foreach (var space in _selectedSpaces)
            {
                <tr @onclick="() => Select(space)">
                    <td>@space.Name</td>
                    <td>@space.Id</td>
                    <td>@space.CreatedAt</td>
                    <td>@space.UpdatedAt</td>
                    <td>@space.Metadata?.Latitude?.ToString("0.###")</td>
                    <td>@space.Metadata?.Longitude?.ToString("0.###")</td>
                    <td>@SelectSpacesWithParent(Spaces, space.Id).Count</td>
                    <td>@space.Points?.PointNodes?.Count</td>
                </tr>
            }
        }
    </tbody>
</table>

<br />
<br />
<PointTable Points="_selectedSpace?.Points?.PointNodes"
@bind-SelectedPoint="_childSelectedPoint" 
@bind-ChildSelectedSignal="_childSelectedSignal"></PointTable>


@code {

    // Input to component
    [Parameter]
    public List<SpaceNode>? Spaces { get; set; }

    private List<SpaceNode>? _selectedSpaces;
    private SpaceNode? _selectedSpace;
    private PointNode? _childSelectedPoint;
    private SignalNode? _childSelectedSignal;


    // List spaces based on selection from user
    private void Select(SpaceNode space)
    {
        // clicked by user
        _selectedSpace = space;
        string? parentId = _selectedSpace.Id;

        // Get spaces with selected space as parent
        _selectedSpaces = SelectSpacesWithParent(Spaces, parentId);
    }

    protected override void OnInitialized()
    {
        _selectedSpaces = SelectSpacesWithParent(Spaces, null);
    }

    private void Home()
    {
        _selectedSpaces = SelectSpacesWithParent(Spaces, null);
        
        // Remove selection
        _selectedSpace = null;
        _childSelectedPoint = null;
        _childSelectedSignal = null;
    }

    // Select spaces in spaces with a specific parentId, use null to select spaces with no parent 
    private List<SpaceNode> SelectSpacesWithParent(List<SpaceNode>? spaces, string? parentId)
    {
        var result = (from space in spaces
                      where space.Parent?.Id == parentId
                      select space).ToList();

        return result;
    }

}
